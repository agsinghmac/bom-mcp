<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP Dashboard</title>
  <style>
    :root {
      --color-bg: var(--color-bg-primary, #1a1a2e);
      --color-bg-secondary: var(--color-bg-secondary, #16213e);
      --color-border: var(--color-border, #2d3748);
      --color-text: var(--color-text-primary, #e2e8f0);
      --color-text-secondary: var(--color-text-secondary, #a0aec0);
      --color-accent: var(--color-accent, #3b82f6);
      --color-critical: #ef4444;
      --color-assembly: #22c55e;
      --color-esp: #3b82f6;
      --radius: var(--radius-md, 8px);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
      color: var(--color-text);
      background: var(--color-bg);
      padding: 16px;
      line-height: 1.5;
      min-height: 100vh;
    }

    .header {
      margin-bottom: 20px;
    }

    h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
    .subtitle { color: var(--color-text-secondary); font-size: 0.875rem; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-accent);
      font-family: var(--font-mono, 'SF Mono', Monaco, monospace);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    .critical-alert {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--color-critical);
      border-radius: var(--radius);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .critical-header {
      background: var(--color-critical);
      color: white;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .critical-header button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
    }

    .critical-header button:hover { background: rgba(255,255,255,0.3); }

    .critical-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .critical-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 16px;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.875rem;
    }

    .critical-item:last-child { border-bottom: none; }
    .critical-item:hover { background: var(--color-bg-secondary); }

    .critical-item .part-num {
      font-family: var(--font-mono, 'SF Mono', Monaco, monospace);
      color: var(--color-accent);
      cursor: pointer;
    }

    .critical-item .part-num:hover { text-decoration: underline; }

    .series-section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .series-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    .series-badge {
      padding: 8px 12px;
      border-radius: var(--radius);
      text-align: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .series-redzone { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
    .series-aquamax { background: rgba(6, 182, 212, 0.2); color: #06b6d4; border: 1px solid #06b6d4; }
    .series-hydrolift { background: rgba(20, 184, 166, 0.2); color: #14b8a6; border: 1px solid #14b8a6; }
    .series-powerpump { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid #f59e0b; }
    .series-deepwell { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; border: 1px solid #8b5cf6; }

    .search-section {
      margin-bottom: 20px;
    }

    .search-box {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.875rem;
      background: var(--color-bg-secondary);
      color: var(--color-text);
    }

    .search-box:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .search-results {
      margin-top: 12px;
      max-height: 250px;
      overflow-y: auto;
    }

    .search-result-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      margin-bottom: 4px;
      background: var(--color-bg-secondary);
      font-size: 0.875rem;
    }

    .search-result-item .part-num {
      font-family: var(--font-mono, 'SF Mono', Monaco, monospace);
      color: var(--color-accent);
    }

    .loading {
      text-align: center;
      padding: 24px;
      color: var(--color-text-secondary);
    }

    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .series-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <h1>ESP Dashboard</h1>
      <p class="subtitle">Electric Submersible Pump Overview</p>
    </div>

    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-esps">-</div>
        <div class="stat-label">Total ESPs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-parts">-</div>
        <div class="stat-label">Total Parts</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-assemblies">-</div>
        <div class="stat-label">Assemblies</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-critical">-</div>
        <div class="stat-label">Critical Parts</div>
      </div>
    </div>

    <div class="critical-alert">
      <div class="critical-header">
        <span>Critical Parts Alert</span>
        <button id="refresh-critical">Refresh</button>
      </div>
      <div class="critical-list" id="critical-list">
        <div class="loading">Loading critical parts...</div>
      </div>
    </div>

    <div class="search-section">
      <input type="text" class="search-box" id="search-input" placeholder="Search parts by name, category, or material...">
      <div class="search-results" id="search-results"></div>
    </div>

    <div class="series-section">
      <div class="section-title">ESP Series Distribution</div>
      <div class="series-grid" id="series-grid">
        <div class="series-badge series-redzone">
          <div>RedZone Pro</div>
          <div id="count-redzone">-</div>
        </div>
        <div class="series-badge series-aquamax">
          <div>AquaMax</div>
          <div id="count-aquamax">-</div>
        </div>
        <div class="series-badge series-hydrolift">
          <div>HydroLift</div>
          <div id="count-hydrolift">-</div>
        </div>
        <div class="series-badge series-powerpump">
          <div>PowerPump</div>
          <div id="count-powerpump">-</div>
        </div>
        <div class="series-badge series-deepwell">
          <div>DeepWell</div>
          <div id="count-deepwell">-</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { App } from 'https://cdn.jsdelivr.net/npm/@modelcontextprotocol/ext-apps@1.0.1/dist/src/app-with-deps.js';

    const app = new App({ name: 'ESP Dashboard', version: '1.0.0' });

    let statsData = null;
    let criticalParts = [];
    let allESPs = [];

    app.onhostcontextchanged = (ctx) => {
      if (ctx.styles?.variables) {
        Object.entries(ctx.styles.variables).forEach(([key, val]) => {
          document.documentElement.style.setProperty(`--${key}`, val);
        });
      }
      if (ctx.safeAreaInsets) {
        document.body.style.padding = `${ctx.safeAreaInsets.top}px ${ctx.safeAreaInsets.right}px ${ctx.safeAreaInsets.bottom}px ${ctx.safeAreaInsets.left}px`;
      }
    };

    app.ontoolresult = (result) => {
      const data = result?.data || result;
      const toolName = result?._meta?.toolName;

      if (toolName === 'get_stats' || (!toolName && data?.total_esps !== undefined)) {
        statsData = data;
        renderStats();
      } else if (toolName === 'get_critical_parts' || Array.isArray(data)) {
        // Check if it's critical parts (has is_critical)
        if (data.length > 0 && data[0]?.is_critical !== undefined) {
          criticalParts = data;
          renderCriticalParts();
        } else if (data.length > 0 && data[0]?.esp_id) {
          // It's ESPs for series count
          allESPs = data;
          renderSeriesCounts();
        }
      }
    };

    app.onteardown = async () => ({ return {}; });

    await app.connect();

    // Load initial data
    app.callTool('get_stats', {});
    app.callTool('get_critical_parts', {});
    app.callTool('list_esps', {});

    // Event handlers
    document.getElementById('refresh-critical').addEventListener('click', () => {
      app.callTool('get_critical_parts', {});
    });

    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      if (query.length < 2) {
        document.getElementById('search-results').innerHTML = '';
        return;
      }
      searchTimeout = setTimeout(() => {
        app.callTool('search_parts', { query });
      }, 300);
    });

    // Also handle search results
    const originalOnToolResult = app.ontoolresult;
    app.ontoolresult = (result) => {
      const data = result?.data || result;
      const toolName = result?._meta?.toolName;

      if (toolName === 'search_parts') {
        renderSearchResults(data);
        return;
      }

      // Original handler
      if (toolName === 'get_stats' || (!toolName && data?.total_esps !== undefined)) {
        statsData = data;
        renderStats();
      } else if (toolName === 'get_critical_parts' || (Array.isArray(data) && data.length > 0 && data[0]?.is_critical !== undefined)) {
        criticalParts = data;
        renderCriticalParts();
      } else if (toolName === 'list_esps' || (Array.isArray(data) && data.length > 0 && data[0]?.esp_id)) {
        allESPs = data;
        renderSeriesCounts();
      }
    };

    function renderStats() {
      if (!statsData) return;
      document.getElementById('stat-esps').textContent = statsData.total_esps || 0;
      document.getElementById('stat-parts').textContent = statsData.total_parts || 0;
      document.getElementById('stat-assemblies').textContent = statsData.total_assemblies || 0;
      document.getElementById('stat-critical').textContent = statsData.critical_parts || 0;
    }

    function renderCriticalParts() {
      const container = document.getElementById('critical-list');
      if (!criticalParts || criticalParts.length === 0) {
        container.innerHTML = '<div class="critical-item">No critical parts</div>';
        return;
      }
      container.innerHTML = criticalParts.map(p => `
        <div class="critical-item">
          <span class="part-num" data-part="${p.part_number}">${p.part_number}</span>
          <span>${p.name}</span>
        </div>
      `).join('');

      container.querySelectorAll('.part-num').forEach(el => {
        el.addEventListener('click', () => {
          app.callTool('get_part', { part_number: el.dataset.part });
        });
      });
    }

    function renderSearchResults(parts) {
      const container = document.getElementById('search-results');
      if (!parts || parts.length === 0) {
        container.innerHTML = '<div class="search-result-item">No results found</div>';
        return;
      }
      container.innerHTML = parts.slice(0, 10).map(p => `
        <div class="search-result-item">
          <span class="part-num" data-part="${p.part_number}">${p.part_number}</span>
          <span>${p.name}</span>
          <span>${p.category}</span>
        </div>
      `).join('');

      container.querySelectorAll('.part-num').forEach(el => {
        el.addEventListener('click', () => {
          app.callTool('get_part', { part_number: el.dataset.part });
        });
      });
    }

    function renderSeriesCounts() {
      if (!allESPs || allESPs.length === 0) return;
      const counts = {
        'RedZone Pro': 0,
        'AquaMax': 0,
        'HydroLift': 0,
        'PowerPump': 0,
        'DeepWell': 0
      };
      allESPs.forEach(esp => {
        if (counts[esp.series] !== undefined) {
          counts[esp.series]++;
        }
      });
      document.getElementById('count-redzone').textContent = counts['RedZone Pro'];
      document.getElementById('count-aquamax').textContent = counts['AquaMax'];
      document.getElementById('count-hydrolift').textContent = counts['HydroLift'];
      document.getElementById('count-powerpump').textContent = counts['PowerPump'];
      document.getElementById('count-deepwell').textContent = counts['DeepWell'];
    }
  </script>
</body>
</html>
